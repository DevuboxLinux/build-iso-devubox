# ============================================================
# Devubox-MX: install and Runtime Setup
# This workflow prepares a lightweight desktop (XFCE) with
# VNC / noVNC and required build tools so the ISO build script
# (which requires interactive TUI input) can be run manually.
# The top of your workflow uses a `sleep infinity` step to
# keep the runner alive for interactive testing.
# ============================================================

name: Devubox-MX ISO Build Environment (Stable)

on:
  workflow_dispatch:   # Manual start

jobs:
  desktop:
    runs-on: ubuntu-latest
    steps:
      - name: Speed up installs (disable man-db)
        run: |
          # Make package installs faster by disabling man-db auto update
          sudo rm -f /var/lib/man-db/auto-update || true
          sudo sh -c 'echo "path-exclude /usr/share/man/*" > /etc/dpkg/dpkg.cfg.d/01_nodocs'

      - name: Update system and install XFCE, VNC, QEMU, and build tools
        run: |
          # Update package lists
          sudo apt-get update

          # Install desktop environment and utilities (no recommended packages)
          sudo apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal thunar file-roller thunar-archive-plugin \
            mousepad xfce4-taskmanager xfce4-screenshooter galculator ristretto \
            tigervnc-standalone-server tigervnc-tools tigervnc-common novnc websockify \
            dbus-x11 x11-utils x11-xserver-utils stress-ng curl wget unzip

          # Install build tools and QEMU
          sudo apt-get install -y \
            qemu-system-x86 tigervnc-viewer virt-manager debootstrap expect \
            squashfs-tools genisoimage xorriso zsync debconf-utils kmod \
            syslinux-utils cpio

          # Clone Devubox-MX ISO build script (into the workspace)
          git clone https://github.com/DevuboxLinux/build-iso-devubox

          # Download required .deb files (Devuan packages used by the build)
          wget "https://pkgmaster.devuan.org/devuan/pool/main/d/debootstrap/debootstrap_1.0.141devuan1_all.deb"
          wget "https://pkgmaster.devuan.org/devuan/pool/main/d/devuan-keyring/devuan-keyring_2025.08.09_all.deb"

          # Install downloaded .debs, then fix/install missing deps
          sudo dpkg -i ./debootstrap_1.0.141devuan1_all.deb ./devuan-keyring_2025.08.09_all.deb || true
          sudo apt-get install -f -y

      - name: Setup VNC password and xstartup
        run: |
          # Create .vnc directory
          mkdir -p ~/.vnc

          # Create VNC password ("live")
          echo "live" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd

          # Write VNC xstartup to launch XFCE session
          cat > ~/.vnc/xstartup <<'EOF'
#!/bin/sh
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
exec dbus-launch --exit-with-session startxfce4
EOF
          chmod +x ~/.vnc/xstartup

      - name: Start VNC server
        run: |
          # Start VNC on display :1
          vncserver :1 -geometry 1366x768 -depth 24

      - name: Start noVNC (websockify)
        run: |
          # Serve the noVNC web client and proxy to VNC display :1 (5901)
          # Run in background so the workflow can continue.
          websockify --web /usr/share/novnc/ 8080 localhost:5901 &

          # Give noVNC a moment to start
          sleep 5

      - name: Install cloudflared and VSCodium
        run: |
          # Download cloudflared (to expose local services if needed)
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb

          # Download a VSCodium build for remote editing
          wget https://github.com/VSCodium/vscodium/releases/download/1.105.17075/codium_1.105.17075_amd64.deb

          # Install them (ignore dpkg errors, then fix deps)
          sudo dpkg -i cloudflared-linux-amd64.deb codium_1.105.17075_amd64.deb || true
          sudo apt-get install -f -y

      - name: Keep alive until manually stopped
        run: |
          echo "The desktop environment is now running and ready to compile and test your distro graphically."
          echo "If you encounter any issues, you can stop this workflow at any time using 'Stop workflow'."
          echo ""
          echo "To build the Devubox-MX ISO, open the Terminal from the Start menu and enter the following commands:"
          echo ""
          echo "cd /mnt"
          echo "sudo git clone https://github.com/DevuboxLinux/build-iso-devubox"
          echo "sudo cd build-iso-devubox"
          echo "sudo ./build-iso --user-default defaults-Base-sysv"
          echo ""
          echo "Follow the on-screen instructions in the terminal."
          echo "When the build is complete, the ISO will be available in 'Remaster/iso-files'."
          echo ""
          echo "To test the ISO, run:"
          echo "sudo qemu-system-x86_64 --enable-kvm -m 4096 -cpu host -smp cores=2,sockets=1,threads=1 -net nic -net user -vnc :0 -usb -device usb-tablet -vga virtio -cdrom ./Remaster/iso-files/*.iso"
          echo ""
          echo "Next, open TigerVNC Viewer from the Start menu and connect to '127.0.0.1'."
          echo ""
          echo "And just like that â€” Devubox-MX is up and running, ready to be published!"
          sleep infinity

